# 競馬予想に必要なJRDBデータ取得計画

## 概要

競馬予想モデルの構築・運用に必要なJRDBデータを、優先度別・段階別に取得する計画です。

## データ取得の優先度と段階

### 🔴 フェーズ1: 基本予想モデル（必須データ）

予想モデルの基本となるデータを取得します。

#### 1. レース情報・条件データ
- **BAC/BAB**: JRDB番組データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Bac/index.html` または `https://jrdb.com/member/data/Bab/index.html`
  - **ファイル形式**: `BAC251102.lzh`（単体）または `BAC_2024.lzh`（年度パック）
  - **更新タイミング**: 金土 19:00
  - **用途**: レース条件（距離、コース、馬場状態、天候予想）、出走馬一覧、レースグレード、賞金

- **KAB/KAA**: JRDB開催データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Kab/index.html` または `https://jrdb.com/member/data/Kaa/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: 馬場状態、天候予想、開催情報

#### 2. 馬の過去成績データ
- **ZED/ZEC**: JRDB前走データ（過去5走）
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Zed/index.html` または `https://jrdb.com/member/data/Zec/index.html`
  - **ファイル形式**: `ZED251102.lzh`（単体）または `ZED_2024.lzh`（年度パック）
  - **更新タイミング**: 金土 19:00
  - **用途**: 過去5走の成績データ（着順、タイム、距離、馬場状態など）

#### 3. 馬の基本情報
- **KYI/KYH/KYG**: JRDB競走馬データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Kyg/index.html`
  - **ファイル形式**: `KYG251102.lzh`（単体）または `KYG_2024.lzh`（年度パック）
  - **更新タイミング**: 金土 19:00
  - **用途**: 競走馬ごとのデータ（IDM、各指数、馬の状態、装具、脚元など）

- **UKC**: JRDB馬基本データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Ukc/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: 血統登録番号、性別、生年月日、血統情報

### 🟡 フェーズ2: 精度向上（推奨データ）

予想精度を向上させるために重要なデータを取得します。

#### 4. 調教データ
- **CYB/CYA**: JRDB調教分析データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Cyb/index.html` または `https://jrdb.com/member/data/Cya/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: 調教内容による調子判定、仕上がり度の評価

- **CHA**: JRDB調教本追切データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Cha/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: 最終追い切りによる調子判定

#### 5. 騎手・調教師データ
- **KZA/KSA**: JRDB騎手データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Kza/index.html` または `https://jrdb.com/member/data/Ksa/index.html`
  - **更新タイミング**: 木 19:00
  - **用途**: 全騎手の成績データ（勝率、連対率、複勝率など）

- **CZA/CSA**: JRDB調教師データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Cza/index.html` または `https://jrdb.com/member/data/Csa/index.html`
  - **更新タイミング**: 木 19:00
  - **用途**: 全調教師の成績データ（勝率、連対率、複勝率など）

#### 6. 拡張データ
- **KKA**: JRDB競走馬拡張データ
  - **取得方法**: JRDBパックに同梱（または単独取得）
  - **更新タイミング**: 金土 19:00
  - **用途**: より詳細な馬の状態分析

### 🟢 フェーズ3: 高度な予想モデル（当日予想用）

当日予想時に精度を大幅に向上させるデータを取得します。

#### 7. 直前情報データ（最重要）
- **TYB**: JRDB直前情報データ（最終版）
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Tyb/index.html`
  - **ファイル形式**: `TYB251102.lzh`（単体）または `TYB_2024.lzh`（年度パック）
  - **更新タイミング**: 土日 17:00（レース当日直前）
  - **用途**: 
    - 出走直前の馬の状態（体重、増減）
    - 馬場適性（芝/ダート、距離、コース形状）
    - 脚元状態（脚元コード）
    - 装具情報（馬具コード）
    - その他直前の特記事項
  - **重要性**: 
    - 前日情報と異なる場合がある（最終調整）
    - 予想精度を大きく左右する可能性が高い
    - 当日の天候・馬場状態の変化を反映

#### 8. 情報データ
- **JOA**: JRDB情報データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Joa/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: 情報からの詳細データによる予想精度の向上

#### 9. 全成績データ
- **SED/SEC**: JRDB成績データ（成績分析用）
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Sed/index.html` または `https://jrdb.com/member/data/Sec/index.html`
  - **更新タイミング**: 木 17:00（週次）、土日 17:00（速報）
  - **用途**: 全成績データによる長期成績分析、統計的特徴量の生成

- **ZKB**: JRDB前走拡張データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Zkb/index.html`
  - **更新タイミング**: 金土 19:00
  - **用途**: より詳細な過去成績分析

### ⚪ フェーズ4: 検証・分析用データ

予想精度の検証や分析に使用するデータです。

#### 10. オッズデータ
- **OZ/OW/OU/OT/OV**: 基準オッズデータ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **更新タイミング**: 金土 19:00
  - **用途**: 予想精度の検証、市場との比較分析

#### 11. 払戻情報データ
- **HJC/HJA**: JRDB払戻情報データ
  - **取得方法**: メンバーページから年度パックまたは単体データをダウンロード
  - **URL例**: `https://jrdb.com/member/data/Hjc/index.html` または `https://jrdb.com/member/data/Hja/index.html`
  - **更新タイミング**: 土日 17:00
  - **用途**: 結果の検証、予想精度の評価

## データ取得方法

### メンバーページからのアクセス

各データタイプのメンバーページにアクセスして、年度パックまたは単体データをダウンロードします。

- **URL形式**: `https://jrdb.com/member/data/{データ種別コード}/index.html`
  - データ種別コードは大文字小文字を区別（例: `Tyb`, `Kyg`, `Bac`）

### データ提供形式

各データタイプのページには、以下の2つのセクションがあります：

1. **年度パックコーナー**: 年度ごとのパックデータ（例: `TYB_2024.lzh`）
   - 1年分のデータをまとめたもの
   - 過去データの一括取得に便利
   - 提供期間: 1999年〜現在年（データタイプによって異なる）

2. **単体データコーナー**: 日付別の単体データ（例: `TYB251102.lzh`）
   - 特定の日付のデータ
   - 最新データを中心に提供

### データ取得の推奨方法

#### 過去データの一括取得（推奨）
- **年度パックを使用**: 1年分のデータを一度に取得できるため効率的
- **例**: `TYB_2024.lzh`, `KYG_2024.lzh`, `BAC_2024.lzh`など

#### 最新データの取得
- **単体データを使用**: 最新の日付のデータのみを取得
- **例**: `TYB251102.lzh`, `KYG251102.lzh`など

## データ取得のタイミング

### 前日予想（金曜夜 19:00以降）
- ✅ 前日情報系データ（金土 19:00更新済み）
  - BAC/BAB, KYI/KYH/KYG, UKC, ZED/ZEC
  - CYB/CYA, CHA, KZA/KSA, CZA/CSA, KKA
- ❌ TYB（まだ更新されていない）
- **使用データ**: フェーズ1 + フェーズ2

### 当日予想（土日 17:00以降）
- ✅ 前日情報系データ（金土 19:00更新済み）
- ✅ **TYB（17:00更新済み）** ← **最重要**
- **使用データ**: フェーズ1 + フェーズ2 + **TYB（フェーズ3）**

### 週次分析（木曜夜以降）
- ✅ 成績データ（木 17:00更新済み）
- ✅ 騎手・調教師データ（木 19:00更新済み）
- **使用データ**: 全フェーズのデータ

## 実装計画

### 1. データ取得機能の実装

既存の`apps/functions/src/jrdb_scraper/downloader.ts`を拡張：

```typescript
// メンバーページから年度パックまたは単体データのURL一覧を取得
async function getJRDBDataList(dataType: string): Promise<string[]>

// 年度パックをダウンロード
async function downloadYearPack(dataType: string, year: number): Promise<Buffer>

// 単体データをダウンロード
async function downloadSingleData(dataType: string, date: string): Promise<Buffer>
```

### 2. データ変換・保存機能

既存の`apps/functions/src/jrdb_scraper/handlers.ts`を活用：

- lzhファイルをParquet形式に変換
- Firebase Storageに保存
- データ種別ごとにフォルダ分け（`jrdb_data/{dataType}/`）

### 3. バッチ取得処理

複数年度のデータを一括取得する処理：

```typescript
// 複数年度の年度パックを一括取得
async function batchDownloadYearPacks(
  dataType: string, 
  years: number[]
): Promise<void>

// 複数データタイプを一括取得
async function batchDownloadDataTypes(
  dataTypes: string[], 
  year: number
): Promise<void>
```

### 4. 自動取得スケジュール

Cloud Functionsのスケジュール実行で自動取得：

- **金曜夜 19:00**: 前日情報系データを取得
- **土日 17:00**: 直前情報データ（TYB）を取得
- **木曜夜 19:00**: 騎手・調教師データを取得

## データストレージ構造

Firebase Storage内のディレクトリ構造：

```
jrdb_data/
├── bac/              # 番組データ（BAC）
│   ├── bac_2024.parquet
│   ├── bac_2023.parquet
│   └── ...
├── ky/               # 競走馬データ（KY）
│   ├── ky_2024.parquet
│   └── ...
├── ze/               # 前走データ（ZE）
│   ├── ze_2024.parquet
│   └── ...
├── ty/               # 直前情報データ（TYB）
│   ├── ty_2024.parquet
│   └── ...
├── uk/               # 馬基本データ（UKC）
├── cy/               # 調教分析データ（CYB/CYA）
├── ch/               # 調教本追切データ（CHA）
├── kz/               # 騎手データ（KZA/KSA）
├── cz/               # 調教師データ（CZA/CSA）
├── kk/               # 競走馬拡張データ（KKA）
├── jo/               # 情報データ（JOA）
├── se/               # 成績データ（SED/SEC）
├── zk/               # 前走拡張データ（ZKB）
├── oz/               # 基準オッズデータ（OZ）
└── hj/               # 払戻情報データ（HJC/HJA）
```

## 実装順序

### 第1段階: 基本データの取得（フェーズ1）
1. BAC/BAB: 番組データの取得・変換
2. ZED/ZEC: 前走データの取得・変換
3. KYI/KYH/KYG: 競走馬データの取得・変換
4. UKC: 馬基本データの取得・変換

### 第2段階: 精度向上データの取得（フェーズ2）
5. CYB/CYA: 調教分析データの取得・変換
6. CHA: 調教本追切データの取得・変換
7. KZA/KSA: 騎手データの取得・変換
8. CZA/CSA: 調教師データの取得・変換
9. KKA: 競走馬拡張データの取得・変換

### 第3段階: 高度なデータの取得（フェーズ3）
10. TYB: 直前情報データの取得・変換（**最重要**）
11. JOA: 情報データの取得・変換
12. SED/SEC: 成績データの取得・変換
13. ZKB: 前走拡張データの取得・変換

### 第4段階: 検証データの取得（フェーズ4）
14. OZ/OW/OU/OT/OV: オッズデータの取得・変換
15. HJC/HJA: 払戻情報データの取得・変換

## 注意事項

### データアクセス制限
- **アクセス時間**: 平日 08:00-19:00
- **認証**: 会員ページへのアクセスには認証が必要
  - 環境変数: `JRDB_USERNAME`, `JRDB_PASSWORD`

### データ取得のタイミング
- **前日情報系**: 金土 19:00更新 → 金曜夜19:00以降に取得
- **直前情報**: 土日 17:00更新 → 土日17:00以降に取得
- **成績データ**: 木 17:00更新 → 木曜夜17:00以降に取得
- **騎手・調教師データ**: 木 19:00更新 → 木曜夜19:00以降に取得

### 過去データの取得
- **年度パック**: 1999年以降のデータが年度ごとに提供
- **単体データ**: 最新データを中心に提供（過去データは週単位で対応）

### データ形式
- **ファイル形式**: lha圧縮形式（.lzh）
- **データ形式**: 固定長テキスト形式（ShiftJISエンコーディング）
- **変換処理**: lzh展開 → ShiftJIS→UTF-8変換 → 固定長テキスト解析 → Parquet変換

## 参考リンク

- [JRDBデータのご案内](https://jrdb.com/program/data.html)
- [JRDB仕様書一覧](.cursor/rules/JRDB_SPECIFICATIONS.mdc)
- [JRDBデータParquet変換計画](PLAN_JRDB_PARQUET_STORAGE.md)

