# 的中率向上のための修正案

## 現状分析

### 現在の実装状況
- **特徴量数**: 145カラム（統計量、前走情報、直近レース情報を含む）
- **モデル**: LambdaRank（LightGBM）
- **ハイパーパラメータ**: Optunaでチューニング（150試行）
- **特徴量強化**: `train_rank_model_v1.py`で`enhance_features`を使用済み
- **未使用**: `train_rank_model.py`（通常版）では特徴量強化が未使用

### 問題点
1. ✅ **レース内相対特徴量**: `train_rank_model_v1.py`で使用済み、ただし追加可能な特徴量あり
2. ✅ **インタラクション特徴量**: `train_rank_model_v1.py`で使用済み、ただし追加可能な特徴量あり
3. ❌ **レース条件との適合度が未考慮**: 距離適性と実際の距離の差など
4. ❌ **直近レース情報の相対特徴量が未追加**: 調教師・騎手の直近レース情報の順位
5. ❌ **データ量が限定的**: 2024年のみのデータ

## 修正案

### 1. 特徴量エンジニアリング（優先度: 高）

#### 1.1 レース内相対特徴量の拡充（追加）
- **現状**: `train_rank_model_v1.py`で基本実装済み
- **追加案**: 以下の特徴量の順位を追加
  - 調教師の直近レース情報の順位（`trainer_recent_1_rank_rank`など）
  - 騎手の直近レース情報の順位（`jockey_recent_1_rank_rank`など）
  - 前走タイムの距離正規化後の順位（距離100mあたりのタイムで比較）
  - 調教師・騎手の直近レースタイムの順位

#### 1.2 インタラクション特徴量の拡充（追加）
- **現状**: `train_rank_model_v1.py`で基本実装済み
- **追加案**: 以下の組み合わせを追加
  - 直近レース情報 × 現在レース条件（`jockey_recent_1_course_type_x_course_type`など）
  - 調教師の直近レース × 現在レース条件（`trainer_recent_1_course_type_x_course_type`など）
  - 距離適性 × 前走距離（`distance_aptitude_x_prev_1_distance`など）
  - 統計量 × 直近レース成績（`horse_win_rate_x_jockey_recent_1_rank`など）

#### 1.3 レース条件適合度特徴量の追加（新規）
- **効果**: レース条件との適合度を数値化
- **実装**: 新規追加
- **追加される特徴量**:
  - `distance_fit_score`: 距離適性と実際の距離の適合度（差が小さいほど高得点）
  - `course_type_match`: 前走コースタイプと現在コースタイプの一致度（0/1）
  - `ground_condition_match`: 前走馬場状態と現在馬場状態の一致度（0/1）
  - `similar_race_performance`: 類似レース（距離・コースタイプ・馬場状態が近い）での成績

### 2. モデル改善（優先度: 中）

#### 2.1 ハイパーパラメータの最適化
- **現在**: `num_leaves=127`, `learning_rate=0.05`, `optuna_n_trials=150`
- **改善案**:
  - `num_leaves`を増加（127→255）: より複雑なパターンを学習
  - `learning_rate`を調整（0.05→0.03）: より慎重な学習
  - `optuna_n_trials`を増加（150→300）: より良いパラメータ探索
  - `min_data_in_leaf`を削減（10→5）: より細かい分割

#### 2.2 アンサンブル手法の導入
- **効果**: 複数モデルの予測を組み合わせて精度向上
- **実装**: 複数の異なる設定で学習したモデルの平均または重み付き平均
- **方法**:
  - 異なる`random_state`で複数モデルを学習
  - 予測結果の平均を取る

### 3. データ改善（優先度: 中）

#### 3.1 複数年度データの使用
- **現在**: 2024年のみ
- **改善案**: 2023年、2022年も追加（データ量3倍）
- **注意**: 未来情報漏れに注意（時系列分割を維持）

#### 3.2 欠損値処理の改善
- **現在**: NaNを0や平均値で埋めている可能性
- **改善案**: 
  - 欠損値フラグ特徴量を追加（`is_missing_prev_1_rank`など）
  - 欠損値が多い特徴量は除外または別処理

### 4. 評価方法の改善（優先度: 低）

#### 4.1 クロスバリデーションの導入
- **効果**: より信頼性の高い評価
- **実装**: 時系列クロスバリデーション（Time Series Cross-Validation）

#### 4.2 評価指標の追加
- **現在**: NDCG@1,2,3、的中率、平均順位誤差
- **追加**: 
  - Top-3的中率（3着以内の的中率）
  - 回収率（オッズデータがある場合）

## 実装優先順位

### フェーズ1（即座に実装可能、効果大）
1. ✅ レース内相対特徴量の追加（`train_rank_model_v1.py`で実装済み）
2. ✅ インタラクション特徴量の追加（`train_rank_model_v1.py`で実装済み）
3. ⚠️ **レース内相対特徴量の拡充**（調教師・騎手の直近レース情報の順位を追加）
4. ⚠️ **インタラクション特徴量の拡充**（直近レース情報との組み合わせを追加）
5. ⚠️ **レース条件適合度特徴量の追加**（新規実装）

### フェーズ2（中期的に実装）
4. ハイパーパラメータの最適化
5. 複数年度データの使用

### フェーズ3（長期的に実装）
6. アンサンブル手法の導入
7. クロスバリデーションの導入

## 期待される効果

- **現在（`train_rank_model_v1.py`使用時）**: 的中率 10-15%（基本の相対・インタラクション特徴量により）
- **フェーズ1完了時（拡充後）**: 的中率 10-15% → **15-20%**（拡充された特徴量により）
- **フェーズ2完了時**: 的中率 15-20% → **20-25%**（ハイパーパラメータ最適化とデータ量増加により）
- **フェーズ3完了時**: 的中率 20-25% → **25-30%**（アンサンブルにより）

## 注意事項

1. **未来情報漏れ**: 特徴量追加時も未来情報を使用しないこと
2. **計算コスト**: 特徴量追加により計算時間が増加する可能性
3. **過学習**: 特徴量を増やしすぎると過学習のリスクがあるため、特徴量重要度でフィルタリングを検討

