---
alwaysApply: true
---

# æ±ç”¨ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«

## ğŸ¯ åŸºæœ¬åŸå‰‡

### 1. ç°¡ç´ ãªå®Ÿè£…
- **1liner**: å¯èƒ½ãªé™ã‚Š1è¡Œã§è¨˜è¿°
- **ã‚¬ãƒ¼ãƒ‰å¥**: æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¹ãƒˆã‚’é¿ã‘ã‚‹
- **ç°¡æ½”æ€§**: å†—é•·ãªã‚³ãƒ¼ãƒ‰ã‚’é¿ã‘ã‚‹

### 2. ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ­ã‚°ã®æœ€å°åŒ–
- **ã‚³ãƒ¡ãƒ³ãƒˆ**: å¿…è¦æœ€å°é™ã®ã¿è¨˜è¿°
- **console.log**: ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿ä½¿ç”¨ã€æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤

### 3. ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§
- **fallbackã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°**: å¾Œã§ä¸å…·åˆã«ã¤ãªãŒã‚Šã‚„ã™ã„ãŸã‚é¿ã‘ã‚‹
- **å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿**: å¯èƒ½ãªé™ã‚Šå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

### 4. ä¸€æ™‚çš„ãªå®Ÿè£…ã®ç®¡ç†
- **TODOã‚³ãƒ¡ãƒ³ãƒˆ**: ä¸€æ™‚çš„ãªå®Ÿè£…ã«ã¯æ˜ç¢ºã«TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‹
- **æœŸé™ã®æ˜è¨˜**: å¯èƒ½ãªé™ã‚Šä¿®æ­£æœŸé™ã‚’æ˜è¨˜ã™ã‚‹
- **è²¬ä»»è€…ã®æ˜è¨˜**: èª°ãŒä¿®æ­£ã™ã‚‹ã‹ã‚’æ˜ç¢ºã«ã™ã‚‹

### 5. ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã¨å†åˆ©ç”¨æ€§
- **å†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†**: ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã—ã¦å®šç¾©ã™ã‚‹
- **å˜ä¸€è²¬ä»»**: 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯1ã¤ã®è²¬ä»»ã‚’æŒã¤
- **ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ã‚’è¡Œã†

## ğŸ“ å…±é€šã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### é–¢æ•°ã®æ›¸ãæ–¹

#### âŒ æ‚ªã„ä¾‹
```typescript
function validateUser(user: User): boolean {
  if (user) {
    if (user.email) {
      if (user.email.includes('@')) {
        if (user.password) {
          if (user.password.length >= 8) {
            return true;
          } else {
            return false;
          }
        } else {
          return false;
        }
      } else {
        return false;
      }
    } else {
      return false;
    }
  } else {
    return false;
  }
}
```

#### âœ… è‰¯ã„ä¾‹
```typescript
function validateUser(user: User): boolean {
  if (!user) return false;
  if (!user.email?.includes('@')) return false;
  if (!user.password || user.password.length < 8) return false;
  return true;
}
```

## ğŸ”§ å…±é€šå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ã‚¬ãƒ¼ãƒ‰å¥ã®æ´»ç”¨
```typescript
// æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã§ãƒã‚¹ãƒˆã‚’é¿ã‘ã‚‹
function processData(data: any) {
  if (!data) return null;
  if (!data.items) return [];
  if (data.items.length === 0) return [];
  
  return data.items.map(item => transform(item));
}
```

### 2. æ¡ä»¶åˆ†å²ã®ç°¡ç´ åŒ–
```typescript
// ä¸‰é …æ¼”ç®—å­ã®æ´»ç”¨
const status = user.isActive ? 'active' : 'inactive';

// è«–ç†æ¼”ç®—å­ã®æ´»ç”¨
const displayName = user.name || user.email || 'Unknown';
```

### 3. é…åˆ—ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œã®ç°¡ç´ åŒ–
```typescript
// é…åˆ—æ“ä½œ
const activeUsers = users.filter(user => user.isActive);
const userNames = users.map(user => user.name);

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œ
const userData = { id: user.id, name: user.name, email: user.email };
```

### 4. éåŒæœŸå‡¦ç†ã®ç°¡ç´ åŒ–
```typescript
// async/await ã®æ´»ç”¨
const fetchUser = async (id: string) => {
  const response = await api.get(`/users/${id}`);
  return response.data;
};
```

## ğŸš« é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³

### 1. éåº¦ãªãƒã‚¹ãƒˆ
```typescript
// âŒ é¿ã‘ã‚‹
if (condition1) {
  if (condition2) {
    if (condition3) {
      // å‡¦ç†
    }
  }
}

// âœ… æ¨å¥¨
if (!condition1) return;
if (!condition2) return;
if (!condition3) return;
// å‡¦ç†
```

### 2. å†—é•·ãªã‚³ãƒ¡ãƒ³ãƒˆ
```typescript
// âŒ é¿ã‘ã‚‹
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getUser() {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
  const userId = getCurrentUserId();
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const user = fetchUser(userId);
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
  return user;
}

// âœ… æ¨å¥¨
function getUser() {
  const userId = getCurrentUserId();
  return fetchUser(userId);
}
```

### 3. ä¸è¦ãªconsole.log
```typescript
// âŒ é¿ã‘ã‚‹
function processData(data) {
  console.log('ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­:', data);
  const result = data.map(item => {
    console.log('ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç†ä¸­:', item);
    return transform(item);
  });
  console.log('å‡¦ç†å®Œäº†:', result);
  return result;
}

// âœ… æ¨å¥¨
function processData(data) {
  return data.map(transform);
}
```

### 4. fallbackã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°
```typescript
// âŒ é¿ã‘ã‚‹ - å¾Œã§ä¸å…·åˆã«ã¤ãªãŒã‚Šã‚„ã™ã„
function parseRaceData(html: string): RaceData {
  const raceName = extractRaceName(html) || 'ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const grade = extractGrade(html) || 'G1' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const venue = extractVenue(html) || 'æ±äº¬' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  const distance = extractDistance(html) || 1600 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  
  return {
    raceName,
    grade,
    venue,
    distance
  }
}

// âœ… æ¨å¥¨ - å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨
function parseRaceData(html: string): RaceData | null {
  const raceName = extractRaceName(html)
  const grade = extractGrade(html)
  const venue = extractVenue(html)
  const distance = extractDistance(html)
  
  // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒæƒã‚ãªã„å ´åˆã¯nullã‚’è¿”ã™
  if (!raceName || !grade || !venue || !distance) {
    return null
  }
  
  return {
    raceName,
    grade,
    venue,
    distance
  }
}
```

### 5. ä¸€æ™‚çš„ãªå®Ÿè£…ã®ç®¡ç†
```typescript
// âŒ é¿ã‘ã‚‹ - ä¸€æ™‚çš„ãªå®Ÿè£…ãŒä¸æ˜ç¢º
function parseJRACalendar(html: string): any[] {
  // ç¾åœ¨ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  return [
    {
      raceNumber: 1,
      raceName: 'æ¯æ—¥ç‹å† ',
      grade: 'G1',
      distance: 1600,
      surface: 'èŠ',
      venue: 'æ±äº¬',
      date: new Date('2025-10-13'),
      scrapedAt: new Date(),
      weather: 'æ™´',
      trackCondition: 'è‰¯',
      startTime: '15:40',
      description: '3æ­³ä»¥ä¸Šç‰é¦¬é™å®š',
      prize: 100000000
    }
  ]
}

// âœ… æ¨å¥¨ - æ˜ç¢ºãªTODOã‚³ãƒ¡ãƒ³ãƒˆ
function parseJRACalendar(html: string): any[] {
  // TODO: HTMLãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè£… - 2024å¹´12æœˆæœ«ã¾ã§ã«å®Œäº†äºˆå®š (æ‹…å½“: ç”°ä¸­)
  // ç¾åœ¨ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  return [
    {
      raceNumber: 1,
      raceName: 'æ¯æ—¥ç‹å† ',
      grade: 'G1',
      distance: 1600,
      surface: 'èŠ',
      venue: 'æ±äº¬',
      date: new Date('2025-10-13'),
      scrapedAt: new Date(),
      weather: 'æ™´',
      trackCondition: 'è‰¯',
      startTime: '15:40',
      description: '3æ­³ä»¥ä¸Šç‰é¦¬é™å®š',
      prize: 100000000
    }
  ]
}
```

### 6. ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã¨å†åˆ©ç”¨æ€§
```typescript
// âŒ é¿ã‘ã‚‹ - å…¨ã¦ã®å‡¦ç†ãŒ1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„
// index.ts (500è¡Œä»¥ä¸Š)
export const scrapeJRA2025October = onRequest(async (request, response) => {
  // HTMLå–å¾—å‡¦ç†
  const browser = await chromium.launch({ headless: true })
  const page = await browser.newPage()
  await page.goto(url)
  const html = await page.content()
  await browser.close()
  
  // HTMLãƒ‘ãƒ¼ã‚¹å‡¦ç†
  const races = []
  const tableRows = html.match(/<tr[^>]*class="[^"]*race[^"]*"[^>]*>.*?<\/tr>/gi) || []
  tableRows.forEach((element, index) => {
    const raceName = extractRaceName(element)
    const grade = extractGrade(element)
    // ... å¤§é‡ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
  })
  
  // Firestoreä¿å­˜å‡¦ç†
  const batch = db.batch()
  races.forEach(race => {
    const raceId = `${race.date.toISOString().split('T')[0]}_${race.venue}_${race.raceNumber}`
    const docRef = db.collection('races').doc(raceId)
    batch.set(docRef, race)
  })
  await batch.commit()
})

// âœ… æ¨å¥¨ - é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²
// index.ts
import { fetchJRAHtmlWithPlaywright } from './utils/htmlFetcher'
import { parseJRACalendar } from './utils/htmlParser'
import { saveRacesToFirestore } from './utils/firestoreSaver'

export const scrapeJRA2025October = onRequest(async (request, response) => {
  const html = await fetchJRAHtmlWithPlaywright(url)
  const races = parseJRACalendar(html, targetYear, targetMonth)
  const savedCount = await saveRacesToFirestore(races)
  response.send({ success: true, racesCount: races.length, savedCount })
})

// utils/htmlFetcher.ts
export async function fetchJRAHtmlWithPlaywright(url: string): Promise<string> {
  const browser = await chromium.launch({ headless: true })
  try {
    const page = await browser.newPage()
    await page.goto(url)
    return await page.content()
  } finally {
    await browser.close()
  }
}

// utils/htmlParser.ts
export function parseJRACalendar(html: string, year: number, month: number): any[] {
  const raceElements = extractRaceElements(html)
  return raceElements.map((element, index) => parseRaceElement(element, index, year, month))
}

// utils/firestoreSaver.ts
export async function saveRacesToFirestore(races: any[]): Promise<number> {
  if (!races.length) return 0
  
  const batch = db.batch()
  races.forEach(race => {
    const raceId = `${race.date.toISOString().split('T')[0]}_${race.venue}_${race.raceNumber}`
    const docRef = db.collection('races').doc(raceId)
    batch.set(docRef, race)
  })
  
  await batch.commit()
  return races.length
}
```

## ğŸ“‹ å…±é€šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚
- [ ] 1linerã§è¨˜è¿°ã§ãã‚‹ç®‡æ‰€ã¯1è¡Œã§è¨˜è¿°
- [ ] ã‚¬ãƒ¼ãƒ‰å¥ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¹ãƒˆã‚’é¿ã‘ã¦ã„ã‚‹
- [ ] ä¸è¦ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
- [ ] console.logã‚’å‰Šé™¤
- [ ] æ¡ä»¶åˆ†å²ãŒç°¡æ½”
- [ ] é–¢æ•°ãŒå˜ä¸€è²¬ä»»
- [ ] fallbackã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„
- [ ] å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
- [ ] ä¸€æ™‚çš„ãªå®Ÿè£…ã«ã¯æ˜ç¢ºãªTODOã‚³ãƒ¡ãƒ³ãƒˆãŒä»˜ã„ã¦ã„ã‚‹
- [ ] TODOã‚³ãƒ¡ãƒ³ãƒˆã«æœŸé™ã¨è²¬ä»»è€…ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹
- [ ] å†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†ã¯é©åˆ‡ã«ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã•ã‚Œã¦ã„ã‚‹
- [ ] 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ1ã¤ã®è²¬ä»»ã‚’æŒã£ã¦ã„ã‚‹

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ™‚
- [ ] ãƒã‚¹ãƒˆã‚’3ãƒ¬ãƒ™ãƒ«ä»¥ä¸‹ã«æŠ‘åˆ¶
- [ ] æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã‚’æ´»ç”¨
- [ ] ä¸‰é …æ¼”ç®—å­ãƒ»è«–ç†æ¼”ç®—å­ã‚’æ´»ç”¨
- [ ] å†—é•·ãªå‡¦ç†ã‚’çµ±åˆ
- [ ] ä¸€æ™‚çš„ãªå®Ÿè£…ã‚’é©åˆ‡ãªå®Ÿè£…ã«ç½®ãæ›ãˆã‚‹
- [ ] TODOã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã¾ãŸã¯æ›´æ–°ã™ã‚‹
- [ ] å†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã™ã‚‹
- [ ] å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«å¾“ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹

## ğŸ¯ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **å¯èª­æ€§**: ã‚³ãƒ¼ãƒ‰ãŒè‡ªå·±èª¬æ˜çš„ã§ã‚ã‚‹
2. **ç°¡æ½”æ€§**: å¿…è¦æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿè£…
3. **ä¿å®ˆæ€§**: å¤‰æ›´ãŒå®¹æ˜“ãªæ§‹é€ 
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä¸è¦ãªå‡¦ç†ã‚’é¿ã‘ã‚‹
5. **ä¸€è²«æ€§**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ«
6. **å†åˆ©ç”¨æ€§**: æ±ç”¨çš„ãªå‡¦ç†ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²
7. **å˜ä¸€è²¬ä»»**: 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯1ã¤ã®è²¬ä»»ã‚’æŒã¤

---

## ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆ

### 1. æ¡ä»¶åˆ†å²ã®ç°¡ç´ åŒ–
```typescript
// è¤‡é›‘ãªæ¡ä»¶ã‚’é–¢æ•°ã«åˆ†é›¢
const isValidUser = (user: User) => 
  user?.email?.includes('@') && 
  user?.password?.length >= 8;

if (isValidUser(user)) {
  // å‡¦ç†
}
```

### 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œã®ç°¡ç´ åŒ–
```typescript
// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ¼”ç®—å­ã®æ´»ç”¨
const updatedUser = { ...user, lastLogin: new Date() };

// åˆ†å‰²ä»£å…¥ã®æ´»ç”¨
const { name, email } = user;
```

### 3. é…åˆ—æ“ä½œã®ç°¡ç´ åŒ–
```typescript
// ãƒã‚§ãƒ¼ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã®æ´»ç”¨
const activeUserNames = users
  .filter(user => user.isActive)
  .map(user => user.name)
  .filter(name => name);
```

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç°¡ç´ åŒ–
```typescript
// try-catch ã®æœ€å°åŒ–
const safeExecute = (fn: () => any) => {
  try {
    return fn();
  } catch {
    return null;
  }
};
```

### 5. ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã®å®Ÿè£…
```typescript
// å†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²
// utils/htmlFetcher.ts
export async function fetchJRAHtmlWithPlaywright(url: string): Promise<string> {
  const browser = await chromium.launch({ headless: true })
  try {
    const page = await browser.newPage()
    await page.goto(url)
    return await page.content()
  } finally {
    await browser.close()
  }
}

// utils/htmlParser.ts
export function parseJRACalendar(html: string, year: number, month: number): any[] {
  const raceElements = extractRaceElements(html)
  return raceElements.map((element, index) => parseRaceElement(element, index, year, month))
}

// utils/firestoreSaver.ts
export async function saveRacesToFirestore(races: any[]): Promise<number> {
  if (!races.length) return 0
  
  const batch = db.batch()
  races.forEach(race => {
    const raceId = `${race.date.toISOString().split('T')[0]}_${race.venue}_${race.raceNumber}`
    const docRef = db.collection('races').doc(raceId)
    batch.set(docRef, race)
  })
  
  await batch.commit()
  return races.length
}

// index.ts - ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿
import { fetchJRAHtmlWithPlaywright } from './utils/htmlFetcher'
import { parseJRACalendar } from './utils/htmlParser'
import { saveRacesToFirestore } from './utils/firestoreSaver'

export const scrapeJRA2025October = onRequest(async (request, response) => {
  const html = await fetchJRAHtmlWithPlaywright(url)
  const races = parseJRACalendar(html, targetYear, targetMonth)
  const savedCount = await saveRacesToFirestore(races)
  response.send({ success: true, racesCount: races.length, savedCount })
})
```

ã“ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã«å¾“ã†ã“ã¨ã§ã€ä¿å®ˆæ€§ãŒé«˜ãã€èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚